<div class="cadencia-ingresos-container">
    <p-card>
        <ng-template pTemplate="header">
            <div class="card-header">
                <h2>游늵 Cadencia de Ingresos</h2>
                <p>An치lisis de ingresos mensuales proyectados y alertas de contratos</p>
            </div>
        </ng-template>

        <!-- Filtros -->
        <form [formGroup]="filterForm" class="filter-form">
            <div class="filter-grid">
                <div class="field">
                    <label for="rutCliente">Cliente</label>
                    <p-select id="rutCliente" formControlName="rutCliente" [options]="clientesDisponibles()"
                        placeholder="Seleccione un cliente" [showClear]="true" [filter]="true" filterBy="label"
                        optionLabel="label" optionValue="value" (onChange)="onClienteChange($event.value)" />
                </div>

                <div class="field">
                    <label for="fechaDesde">Fecha Desde</label>
                    <p-datepicker id="fechaDesde" formControlName="fechaDesde" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Seleccione fecha" />
                </div>

                <div class="field">
                    <label for="fechaHasta">Fecha Hasta</label>
                    <p-datepicker id="fechaHasta" formControlName="fechaHasta" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Seleccione fecha" />
                </div>

                <!-- Filtro de moneda oculto por ahora -->
                <!-- <div class="field">
          <label for="idTipoMoneda">Moneda</label>
          <p-select
            id="idTipoMoneda"
            formControlName="idTipoMoneda"
            [options]="monedas()"
            placeholder="Todas las monedas"
            [showClear]="true"
            optionLabel="label"
            optionValue="value"
          />
        </div> -->
            </div>

            <div class="filter-actions">
                <p-button label="Buscar" icon="pi pi-search" (onClick)="buscar()" [loading]="loading()" />
                <p-button label="Limpiar" icon="pi pi-times" severity="secondary" (onClick)="limpiar()"
                    [disabled]="loading()" />
                @if (clienteSeleccionado()) {
                <p-button label="Exportar Excel" icon="pi pi-download" severity="success" (onClick)="exportarExcel()"
                    [disabled]="loading()" />
                }
            </div>
        </form>
    </p-card>

    <!-- Loading -->
    @if (loading()) {
    <div class="loading-container">
        <p-progressSpinner />
        <p>Cargando datos...</p>
    </div>
    }

    <!-- Resultados -->
    @if (!loading() && clientes().length > 0) {
    <div class="results-container">

        <!-- Panel de fichas de clientes oculto (se puede habilitar en el futuro) -->
        <!-- @if (clientes().length > 1) {
        <p-card>
          <ng-template pTemplate="header">
            <h3>Seleccione un Cliente</h3>
          </ng-template>
          <div class="clientes-grid">
            @for (cliente of clientes(); track cliente.rutCliente) {
              <div 
                class="cliente-card"
                [class.selected]="clienteSeleccionado()?.rutCliente === cliente.rutCliente"
                (click)="seleccionarCliente(cliente)"
              >
                <h4>{{ cliente.nombreCliente }}</h4>
                <p>{{ cliente.rutCliente }}</p>
                @if (cliente.alertas.length > 0) {
                  <span class="badge-alertas">{{ cliente.alertas.length }} alertas</span>
                }
              </div>
            }
          </div>
        </p-card>
      } -->

        <!-- Detalles del cliente seleccionado -->
        @if (clienteSeleccionado()) {
        <p-card>
            <ng-template pTemplate="header">
                <div class="cliente-header">
                    <div>
                        <h3>
                            @if (clienteSeleccionado()!.rutCliente === 'TODOS') {
                            游늵 {{ clienteSeleccionado()!.nombreCliente }}
                            } @else {
                            {{ clienteSeleccionado()!.nombreCliente }}
                            }
                        </h3>
                        @if (clienteSeleccionado()!.rutCliente !== 'TODOS') {
                        <p class="rut">RUT: {{ clienteSeleccionado()!.rutCliente }}</p>
                        }
                    </div>
                </div>
            </ng-template>

            <!-- Alertas (solo si NO es cadencia total) -->
            @if (alertas().length > 0 && clienteSeleccionado()!.rutCliente !== 'TODOS') {
            <div class="alertas-section">
                <h4>丘멆잺 Alertas Detectadas</h4>
                <div class="alertas-grid">
                    @for (alerta of alertas(); track alerta.mes) {
                    <div class="alerta-card" [ngClass]="getSeverityClass(alerta.severidad)">
                        <div class="alerta-header">
                            <i [class]="getSeverityIcon(alerta.severidad)"></i>
                            <span class="mes">{{ formatMes(alerta.mes) }}</span>
                            <span class="severidad">{{ alerta.severidad }}</span>
                        </div>
                        <p class="mensaje">{{ alerta.mensaje }}</p>
                        <p class="monto">Monto: {{ formatNumber(alerta.montoPerdiendose) }}</p>
                        @if (alerta.serviciosQueTerminan.length > 0) {
                        <button class="btn-detalle" (click)="verDetalleAlerta(alerta)">
                            Ver {{ alerta.serviciosQueTerminan.length }} servicios
                            <i class="pi pi-chevron-right"></i>
                        </button>
                        }
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Gr치fico -->
            <div class="chart-section">
                <h4>游늳 Proyecci칩n de Ingresos Mensuales</h4>
                @if (chartData()) {
                <div class="chart-container">
                    <p-chart type="line" [data]="chartData()!" [options]="chartOptions" [style]="{'height': '100%'}" />
                </div>
                }
            </div>

            <!-- Tabla de datos -->
            <div class="table-section">
                <h4>游늶 Detalle Mensual</h4>
                <p-table [value]="ingresosMensuales()" [tableStyle]="{'min-width': '50rem'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Mes</th>
                            <th class="text-right">Monto</th>
                            <th class="text-right">Variaci칩n</th>
                            <th class="text-center">Servicios Activos</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-mes>
                        <tr>
                            <td>{{ formatMes(mes.mes) }}</td>
                            <td class="text-right">
                                <strong>{{ mes.moneda }} {{ formatNumber(mes.monto) }}</strong>
                            </td>
                            <td class="text-right">
                                <span [ngClass]="getVariacionClass(mes.variacionPorcentaje)">
                                    @if (mes.variacionPorcentaje !== 0) {
                                    {{ mes.variacionPorcentaje > 0 ? '+' : '' }}{{ mes.variacionPorcentaje }}%
                                    <i
                                        [class]="mes.variacionPorcentaje > 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
                                    } @else {
                                    -
                                    }
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge-servicios">{{ mes.serviciosActivos }}</span>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-card>
        }
    </div>
    }

    <!-- Sin resultados -->
    @if (!loading() && clientes().length === 0 && filterForm.dirty) {
    <p-card>
        <div class="no-results">
            <i class="pi pi-inbox" style="font-size: 3rem; color: var(--surface-400);"></i>
            <h3>No se encontraron datos</h3>
            <p>Intente ajustar los filtros de b칰squeda</p>
        </div>
    </p-card>
    }

    <!-- Dialog de detalle de alerta -->
    <app-detalle-alerta-dialog />
</div>