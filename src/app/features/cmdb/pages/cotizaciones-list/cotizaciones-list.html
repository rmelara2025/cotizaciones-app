<div class="contratos-container">
    <h2>Contratos y Cotizaciones</h2>

    <div *ngIf="error" class="error-message px-3">
        <p style="color: #e53238;">⚠️ {{ error }}</p>
    </div>


    <div class="filters-card p-3 mb-3 surface-card border-round shadow-1">
        <div class="grid compact">
            <div class="col-12 md:col-3">
                <label for="rutCliente" class="block mb-2 font-semibold">RUT</label>
                <p-inputGroup>
                    <input pInputText id="rutCliente" [(ngModel)]="filters.rutCliente" placeholder="12345678-9"
                        appRutInput (keyup.enter)="buscar()" class="w-full" />
                    <p-inputGroupAddon>
                        <i class="pi pi-id-card"></i>
                    </p-inputGroupAddon>
                </p-inputGroup>
            </div>
            <div class="col-12 md:col-3">
                <label for="nombreCliente" class="block mb-2 font-semibold">Nombre Cliente</label>
                <p-inputGroup>
                    <input pInputText id="nombreCliente" [(ngModel)]="filters.nombreCliente"
                        placeholder="Telefonica Chile" (keyup.enter)="buscar()" class="w-full" />
                    <p-inputGroupAddon>
                        <i class="pi pi-user"></i>
                    </p-inputGroupAddon>
                </p-inputGroup>



            </div>

            <div class="col-12 md:col-3">

                <label for="estado" class="block mb-2 font-semibold">Estado del Contrato</label>
                <p-inputGroup>
                    <p-select placeholder="Estado" [options]="[
            {label: 'Todos', value: 'todos', },
            {label: 'Sólo Vigentes', value: 'vigente'},
            {label: 'Sólo por Expirar', value: 'por-expirar'},
            {label: 'Sólo Expirados', value: 'expirado'},
        ]" [(ngModel)]="filters.estado" (ngModelChange)="onEstadoChange($event)">
                    </p-select>
                </p-inputGroup>

            </div>

            <div class="col-12 md:col-12 p-0"></div>
            <div class="col-12 md:col-3">



                <label for="codChi" class="block mb-2 font-semibold">Código CHI</label>
                <p-inputGroup>
                    <input pInputText id="codChi" [(ngModel)]="filters.codChi" placeholder="CC-CHI-0000012345"
                        (keyup.enter)="buscar()" class="w-full" />
                    <p-inputGroupAddon>
                        <i class="pi pi-folder"></i>
                    </p-inputGroupAddon>
                </p-inputGroup>

            </div>
            <div class="col-12 md:col-3">


                <label for="codSison" class="block mb-2 font-semibold">Código SISON</label>
                <p-inputGroup>
                    <input pInputText id="codSison" [(ngModel)]="filters.codSison" placeholder="201817664-1"
                        (keyup.enter)="buscar()" class="w-full" />
                    <p-inputGroupAddon>
                        <i class="pi pi-folder"></i>
                    </p-inputGroupAddon>
                </p-inputGroup>

            </div>
            <div class="col-12 md:col-3">

                <label for="codSap" class="block mb-2 font-semibold">Código SAP</label>
                <p-inputGroup>
                    <input pInputText id="codSap" [(ngModel)]="filters.codSap" placeholder="C-12345600012"
                        (keyup.enter)="buscar()" class="w-full" />
                    <p-inputGroupAddon>
                        <i class="pi pi-folder"></i>
                    </p-inputGroupAddon>
                </p-inputGroup>


            </div>

            <div class="col-12 md:col-3 flex align-items-end gap-2">
                <p-button label="Buscar" icon="pi pi-search" (click)="buscar()" class="mr-2"></p-button>
                <p-button label="Limpiar" icon="pi pi-times" severity="secondary" (click)="limpiarFiltros()"></p-button>
                <p-button label="Resumen" icon="pi pi-chart-pie" severity="info"
                    (click)="showResumenDrawer = true"></p-button>
            </div>



        </div>
    </div>





    <p-table [value]="contratos" [loading]="loading" [paginator]="true" [rows]="pageSize" [totalRecords]="totalRecords"
        [lazy]="true" (onLazyLoad)="onPageChange($event)" class="p-datatable-sm" responsiveLayout="scroll"
        [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} clientes"
        [rowsPerPageOptions]="[10, 25, 50]">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="idContrato" style="display: none;">
                    ID Contrato <p-sortIcon field="idContrato"></p-sortIcon>
                </th>
                <th pSortableColumn="rutCliente" style="text-align:center;" class="nowrap-col">
                    RUT <p-sortIcon field="rutCliente"></p-sortIcon>
                </th>
                <th pSortableColumn="nombreCliente" style="text-align:center;">
                    Cliente <p-sortIcon field="nombreCliente"></p-sortIcon>
                </th>
                <th pSortableColumn="fechaInicio" style="text-align:center;">
                    Inicio <p-sortIcon field="fechaInicio"></p-sortIcon>
                </th>
                <th pSortableColumn="fechaTermino" style="text-align:center;">
                    Término <p-sortIcon field="fechaTermino"></p-sortIcon>
                </th>
                <th pSortableColumn="nombreTipoPago" style="text-align:center;">
                    Tipo de Pago <p-sortIcon field="nombreTipoPago"></p-sortIcon>
                </th>

                <th pSortableColumn="codChi" style="text-align:center;" class="nowrap-col">
                    Cód. Proyecto <p-sortIcon field="codChi"></p-sortIcon>
                </th>

                <th>Acciones</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row>
            <tr>
                <td style="display: none;" [style.background]="expiryBg(row)">
                    <a (click)="verDetalle(row)" style="cursor:pointer; color:blue; text-decoration:underline;">
                        {{ row.idContrato }}
                    </a>
                </td>
                <td [style.background]="expiryBg(row)" style="text-align: right;" class="nowrap-col">
                    <span class="p-tag p-tag-info">
                        <i *ngIf="expirySeverity(row)" class="pi pi-exclamation-triangle warning-icon"
                            [ngClass]="{'high': expirySeverity(row) === 'high', 'medium': expirySeverity(row) === 'medium', 'low': expirySeverity(row) === 'low'}"
                            [pTooltip]="getExpiryTooltip(row)" tooltipPosition="top" aria-hidden="true"></i>

                        {{ row.rutCliente | formatRut }}
                    </span>
                </td>
                <td [style.background]="expiryBg(row)">
                    <span class="p-tag p-tag-info">
                        {{ row.nombreCliente }}
                    </span>
                </td>
                <td [style.background]="expiryBg(row)">{{ row.fechaInicio | date: 'dd/MM/yyyy' }}
                </td>
                <td [style.background]="expiryBg(row)">{{ row.fechaTermino | date: 'dd/MM/yyyy' }}</td>
                <td [style.background]="expiryBg(row)">
                    <span class="p-tag p-tag-info">
                        {{ row.nombreTipoPago }}
                    </span>
                </td>

                <td [style.background]="expiryBg(row)" class="nowrap-col">
                    <span class="p-tag p-tag-info">
                        {{ row.codSap ? row.codSap : (row.codChi ? row.codChi : row.codSison) }}
                    </span>
                </td>

                <td>
                    <button pButton pTooltip="Ver cotización" tooltipPosition="left" icon="pi pi-eye"
                        (click)="verDetalle(row)" class="p-button-sm p-button-info"></button>
                </td>
            </tr>
        </ng-template>



        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="10" class="text-center p-4">
                    No hay contratos disponibles
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="footer">
            <!-- <tr style="background-color: #f5f5f5; font-weight: bold;">
                <td colspan="6" style="text-align: right; padding-right: 1rem;">
                    TOTALES POR MONEDA:
                </td>
                <td style="text-align: right;">
                    <div *ngFor="let moneda of (totalesPorMoneda | keyvalue)">
                        <span *ngIf="moneda.value > 0">
                            {{ moneda.key }}: {{ moneda.value | number:'1.0-0' }}
                        </span>
                    </div>
                </td>
                <td colspan="3"></td>
            </tr> -->
        </ng-template>
    </p-table>

    <!-- Drawer de Resumen de Recurrentes -->
    <p-drawer header="Resumen de Recurrentes" position="right" [visible]="showResumenDrawer"
        (onHide)="showResumenDrawer = false" [dismissible]="true" [modal]="false" [blockScroll]="true"
        [style]="{ width: '520px' }">
        <div class="resumen-section">
            <p-table [value]="resumenConSubtotales" styleClass="p-datatable-sm" [tableStyle]="{ 'min-width': '380px' }">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 30%">Moneda</th>
                        <th style="width: 25%">Estado</th>
                        <th style="width: 20%; text-align: right">Contratos</th>
                        <th style="width: 25%; text-align: right">Recurrente</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-item>
                    <tr [ngClass]="{'subtotal-row': item.isSubtotal}">
                        <td [attr.colspan]="item.isSubtotal ? 2 : null">
                            <strong *ngIf="item.isSubtotal">Total {{ item.nombreTipoMoneda }}</strong>
                            <span *ngIf="!item.isSubtotal">{{ item.nombreTipoMoneda }}</span>
                        </td>
                        <td *ngIf="!item.isSubtotal">{{ item.estado == 'por-expirar' ? 'Por Expirar' :
                            item.estado.charAt(0).toUpperCase() +
                            item.estado.slice(1) }}</td>
                        <td style="text-align: right" [ngClass]="{'subtotal-cell': item.isSubtotal}">
                            <strong *ngIf="item.isSubtotal">{{ item.cantidadContratos || 0 }}</strong>
                            <span *ngIf="!item.isSubtotal">{{ item.cantidadContratos || 0 }}</span>
                        </td>
                        <td style="text-align: right; font-weight: 500" [ngClass]="{'subtotal-cell': item.isSubtotal}">
                            <strong *ngIf="item.isSubtotal">{{ formatCurrency(item.totalRecurrente,
                                item.nombreTipoMoneda) }}</strong>
                            <span *ngIf="!item.isSubtotal">{{ formatCurrency(item.totalRecurrente,
                                item.nombreTipoMoneda) }}</span>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="4" class="text-center p-3">
                            <span *ngIf="!loadingResumen">No hay datos de recurrentes</span>
                            <span *ngIf="loadingResumen">Cargando resumen...</span>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </p-drawer>

    <p-dialog [(visible)]="showDetalleDialog" [modal]="true" [style]="{width: '900px'}" (onHide)="closeDetalle()"
        header="Detalle de Cotización">
        <div *ngIf="selectedRow">

            <div class="filters-card p-3 mb-3 surface-card border-round shadow-1">
                <div class="grid">
                    <div class="col-12 md:col-3">
                        <label class="block mb-2 font-semibold">RUT</label>
                        <div>{{ selectedRow.rutCliente | formatRut }}</div>
                    </div>
                    <div class="col-12 md:col-5">
                        <label class="block mb-2 font-semibold">Cliente</label>
                        <div>{{ selectedRow.nombreCliente }}</div>
                    </div>

                    <div class="col-12 md:col-4">
                        <label class="block mb-2 font-semibold">Código Proyecto</label>
                        <div>{{ projectCode(selectedRow) || 'N/A' }}</div>
                    </div>
                    <div class="col-12 md:col-3">
                        <label class="block mb-2 font-semibold">Tipo de Pago</label>
                        <div>{{ selectedRow.nombreTipoPago }}</div>
                    </div>
                    <div class="col-12 md:col-5">

                    </div>
                    <div class="col-12 md:col-4">
                        <label class="block mb-2 font-semibold">Versión Cotización</label>
                        <div>{{ selectedRow.version }}</div>
                    </div>
                </div>
            </div>


            <h3 style="margin-top:1rem">Ítems / Servicio
                <p-button icon="pi pi-plus" [raised]="true" [rounded]="true" size="small" class="p-1" severity="success"
                    pTooltip="Agregar servicio" tooltipPosition="right" id="btnAgregar" (click)="addItem()"></p-button>
            </h3>
            <app-cotizacion-detalle [idContrato]="selectedRow.idContrato" [isModal]="true"></app-cotizacion-detalle>
        </div>
    </p-dialog>
</div>