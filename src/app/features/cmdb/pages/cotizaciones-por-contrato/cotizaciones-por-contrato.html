<div class="cotizaciones-container p-3">

    <div class="flex justify-content-between align-items-center mb-3">
        <h2>Cotizaciones del Contrato</h2>
        <p-button icon="pi pi-arrow-left" label="Volver" (click)="volver()" severity="contrast"></p-button>
    </div>

    <p-panel header="Información del Contrato" class="mb-4">
        @if(contrato()) {
        <div class="grid">
            <div class="col-12 md:col-3">
                <label class="block mb- font-semibold">Cliente</label>
                <p class="font-semibold text-color-secondary">{{ contrato()!.nombreCliente }}</p>
            </div>

            <div class="col-12 md:col-2">
                <label class="block mb-2 font-semibold">RUT</label>
                <p class="font-semibold text-color-secondary">{{ contrato()!.rutCliente | formatRut }}</p>
            </div>

            <div class="col-12 md:col-2">
                <label class="block mb-2 font-semibold">Inicio</label>
                <p class="font-semibold text-color-secondary">{{ contrato()!.fechaInicio | date: 'dd/MM/yyyy' }}</p>
            </div>
            <div class="col-12 md:col-2">
                <label class="block mb-2 font-semibold">Término</label>
                <p class=" font-semibold text-color-secondary">{{ contrato()!.fechaTermino | date: 'dd/MM/yyyy' }}</p>
            </div>
            <div class="col-12 md:col-2">
                <label class="block mb-2 font-semibold">Código Proyecto</label>
                <p class="font-semibold text-color-secondary">{{ contrato()!.codSap || contrato()!.codChi ||
                    contrato()!.codSison }}</p>
            </div>
        </div>
        }

    </p-panel>



    @if (error) {
    <div class="error-message mb-3 p-3 border-round surface-card">
        <p style="color: #e53238;"><i class="pi pi-exclamation-triangle"></i> {{ error }}</p>
    </div>
    }

    <p-panel header="Listado de Cotizaciones">
        <p-table [value]="cotizaciones" [loading]="loading" responsiveLayout="scroll"
            [tableStyle]="{ 'min-width': '60rem' }" stripedRows>
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 15%">Número</th>
                    <th style="width: 8%">Versión</th>
                    <th style="width: 12%">Estado</th>
                    <th style="width: 12%">Fecha Emisión</th>
                    <th style="width: 15%">Vigencia Desde</th>
                    <th style="width: 15%">Vigencia Hasta</th>
                    <th style="width: 15%">Observación</th>
                    <th style="width: 8%">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-cotizacion>
                <tr>
                    <td>
                        <span class="font-semibold">{{ cotizacion.numeroCotizacion }}</span>
                    </td>
                    <td class="text-center">
                        <span class="p-tag p-tag-info">v{{ cotizacion.version }}</span>
                    </td>
                    <td>
                        <p-tag [value]="cotizacion.estadoNombre" [severity]="getEstadoSeverity(cotizacion.estadoNombre)"
                            [pTooltip]="cotizacion.estadoDescripcion" tooltipPosition="top">
                        </p-tag>
                    </td>
                    <td>{{ cotizacion.fechaEmision }}</td>
                    <td>{{ cotizacion.fechaVigenciaDesde || '-' }}</td>
                    <td>{{ cotizacion.fechaVigenciaHasta || '-' }}</td>
                    <td>
                        <span [pTooltip]="cotizacion.observacion" tooltipPosition="top" *ngIf="cotizacion.observacion">
                            {{ cotizacion.observacion.length > 30 ? (cotizacion.observacion | slice:0:30) + '...' :
                            cotizacion.observacion }}
                        </span>
                        <span *ngIf="!cotizacion.observacion" class="text-color-secondary">-</span>
                    </td>
                    <td>
                        <div class="flex gap-1">
                            <!-- Botón Ver Detalle -->
                            <p-button icon="pi pi-folder-open" (click)="onVerDetalle(cotizacion)" severity="info"
                                [rounded]="true" pTooltip="Abrir cotización" size="small">
                            </p-button>

                            <!-- Botones de Transición de Estado -->
                            @for (accion of obtenerAcciones(cotizacion); track accion.idTransicion) {
                            <p-button [icon]="'pi ' + getIconEstado(accion.nombreEstadoDestino)" [rounded]="true"
                                (click)="onAccionClick(accion, cotizacion)"
                                [severity]="getEstadoSeverity(accion.nombreEstadoDestino)" size="small"
                                [pTooltip]="getTextEstado(accion.nombreEstadoDestino)" tooltipPosition="top">
                            </p-button>
                            }
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="text-center p-4">
                        No hay cotizaciones disponibles para este contrato
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-panel>

</div>

<!-- Diálogo para capturar Comentario y/o Motivo de Rechazo -->
<p-dialog [(visible)]="mostrarDialogo" [modal]="true" [style]="{ width: '500px' }" [closable]="!procesandoCambio()"
    [closeOnEscape]="!procesandoCambio()">

    <ng-template pTemplate="header">
        <span class="font-semibold">
            Confirmar: {{ accionSeleccionada()?.descripcion }}
        </span>
    </ng-template>

    <div class="flex flex-column gap-3">
        @if (accionSeleccionada()?.requiereComentario) {
        <div class="field">
            <label for="comentario" class="block mb-2 font-semibold">
                Comentario <span class="text-red-500">*</span>
            </label>
            <textarea id="comentario" pTextarea [(ngModel)]="comentario" rows="3" [style]="{ width: '100%' }"
                placeholder="Ingrese un comentario sobre este cambio..." [disabled]="procesandoCambio()">
                </textarea>
        </div>
        }

        @if (accionSeleccionada()?.requiereMotivoRechazo) {
        <div class="field">
            <label for="motivoRechazo" class="block mb-2 font-semibold">
                Motivo de Rechazo <span class="text-red-500">*</span>
            </label>
            <textarea id="motivoRechazo" pTextarea [(ngModel)]="motivoRechazo" rows="3" [style]="{ width: '100%' }"
                placeholder="Ingrese el motivo del rechazo..." [disabled]="procesandoCambio()">
                </textarea>
        </div>
        }

        <div class="text-sm text-color-secondary">
            <i class="pi pi-info-circle"></i>
            Se cambiará el estado a: <strong>{{ accionSeleccionada()?.nombreEstadoDestino }}</strong>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancelar" severity="secondary" (click)="cerrarDialogo()" [disabled]="procesandoCambio()">
        </p-button>
        <p-button label="Confirmar" severity="success" (click)="confirmarCambioEstado()" [loading]="procesandoCambio()">
        </p-button>
    </ng-template>
</p-dialog>