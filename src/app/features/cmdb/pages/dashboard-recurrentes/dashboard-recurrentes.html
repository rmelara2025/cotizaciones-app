<div class="contratos-container pl-3 pt-3">
    <p-card class="px-5">
        <ng-template pTemplate="title">Dashboard Recurrentes</ng-template>
        <ng-template pTemplate="content">
            <div class="filter-section" style="margin-bottom:1rem;">
                <label for="familiaFilter" style="display:block;margin-bottom:0.25rem;font-weight:500;">Filtrar por Familia de Servicio:</label>
                <p-select 
                    id="familiaFilter"
                    [(ngModel)]="idFamiliaServicioSelected"
                    [options]="familias"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Todas las familias"
                    [showClear]="true"
                    (onChange)="onFamiliaChange()"
                    styleClass="w-full max-w-30rem">
                </p-select>
            </div>

            <div class="controls" style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.5rem;">
                <button pButton type="button" label="Total recurrente" (click)="toggleMetric('totalRecurrente')"
                    [class.p-button-info]="metric==='totalRecurrente'"></button>
                <button pButton type="button" label="Cantidad contratos" (click)="toggleMetric('countContratos')"
                    [class.p-button-info]="metric==='countContratos'"></button>
                <div style="margin-left:auto;font-size:0.95rem;color:rgba(0,0,0,0.6);">Mostrando: <strong>{{ metric ===
                        'totalRecurrente' ? 'Total recurrente (dinero)' : 'Cantidad de contratos' }}</strong></div>
            </div>
            <div class="chart-wrapper">
                <p-chart type="bar" [data]="chartData" [options]="chartOptions" class="chart-container"></p-chart>
            </div>
        </ng-template>
    </p-card>

    <p-card class="summary-card px-5 mt-4">
        <ng-template pTemplate="title">Resumen Recurrentes</ng-template>
        <ng-template pTemplate="content">
            <p-table [value]="summaryConSubtotales" [paginator]="false" [rows]="10" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Tipo Moneda</th>
                        <th>Estado</th>
                        <th style="text-align: right">Total Recurrente</th>
                        <th style="text-align: right">Cantidad Contratos</th>
                        <th style="text-align: right">% del Total</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                    <tr [ngClass]="{'subtotal-row': row.isSubtotal}">
                        <td [attr.colspan]="row.isSubtotal ? 2 : null">
                            <strong *ngIf="row.isSubtotal">Total {{ row.moneda }}</strong>
                            <span *ngIf="!row.isSubtotal">{{ row.moneda }}</span>
                        </td>
                        <td *ngIf="!row.isSubtotal">{{ row.estado }}</td>
                        <td style="text-align: right" [ngClass]="{'subtotal-cell': row.isSubtotal}">
                            <strong *ngIf="row.isSubtotal">{{ formatCurrency(row.totalRecurrente, row.moneda)
                                }}</strong>
                            <span *ngIf="!row.isSubtotal">{{ formatCurrency(row.totalRecurrente, row.moneda) }}</span>
                        </td>
                        <td style="text-align: right" [ngClass]="{'subtotal-cell': row.isSubtotal}">
                            <strong *ngIf="row.isSubtotal">{{ row.countContratos || 0 }}</strong>
                            <span *ngIf="!row.isSubtotal">{{ row.countContratos || 0 }}</span>
                        </td>
                        <td style="text-align: right" [ngClass]="{'subtotal-cell': row.isSubtotal}">
                            <strong *ngIf="row.isSubtotal">{{ row.porcentaje | number:'1.0-1' }}%</strong>
                            <span *ngIf="!row.isSubtotal">{{ row.porcentaje | number:'1.0-1' }}%</span>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-template>
    </p-card>
</div>