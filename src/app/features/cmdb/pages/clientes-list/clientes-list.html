<div class="clientes-container p-4">
    <div class="header-section mb-4">
        <div class="flex justify-content-between align-items-center mb-3">
            <h2 class="text-2xl font-bold">Gestión de Clientes</h2>
            @if (canCreateClient()) {
            <p-button label="Nuevo Cliente" icon="pi pi-plus" (click)="openNewClienteDialog()"></p-button>
            }
        </div>

        <!-- Filtros de búsqueda -->
        <div class="filters-card p-3 mb-3 surface-card border-round shadow-1">
            <div class="grid">
                <div class="col-12 md:col-4">
                    <label for="nombreCliente" class="block mb-2 font-semibold">Nombre</label>
                    <p-inputgroup>
                        <input pInputText id="nombreCliente" [(ngModel)]="filters.nombreCliente"
                            placeholder="Buscar por nombre..." (keyup.enter)="buscarClientes()" class="w-full" />
                        <p-inputgroup-addon>
                            <i class="pi pi-search"></i>
                        </p-inputgroup-addon>
                    </p-inputgroup>
                </div>

                <div class="col-12 md:col-4">
                    <label for="rutCliente" class="block mb-2 font-semibold">RUT</label>
                    <p-inputgroup>
                        <input pInputText id="rutCliente" [(ngModel)]="filters.rutCliente" placeholder="12345678-9"
                            appRutInput (keyup.enter)="buscarClientes()" class="w-full" />
                        <p-inputgroup-addon>
                            <i class="pi pi-id-card"></i>
                        </p-inputgroup-addon>
                    </p-inputgroup>
                </div>

                <div class="col-12 md:col-4 flex align-items-end">
                    <p-button label="Buscar" icon="pi pi-search" (click)="buscarClientes()" class="mr-2"></p-button>
                    <p-button label="Limpiar" icon="pi pi-times" severity="secondary"
                        (click)="limpiarFiltros()"></p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje de error -->
    @if (error) {
    <div class="error-banner p-3 mb-3 surface-overlay border-round border-1 border-red-500">
        <i class="pi pi-exclamation-triangle text-red-500 mr-2"></i>
        <span class="text-red-500">{{ error }}</span>
    </div>
    }

    <!-- Tabla de clientes -->
    <p-table #dt [value]="clientes" [lazy]="true" [paginator]="true" [rows]="pageSize" [totalRecords]="totalRecords"
        [loading]="loading" (onLazyLoad)="onPageChange($event)" [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} clientes"
        [rowsPerPageOptions]="[10, 25, 50]" [tableStyle]="{ 'min-width': '60rem' }">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="rutCliente" style="width: 15%">
                    RUT
                    <p-sortIcon field="rutCliente"></p-sortIcon>
                </th>
                <th pSortableColumn="nombreCliente" style="width: 40%">
                    Nombre
                    <p-sortIcon field="nombreCliente"></p-sortIcon>
                </th>

                <th style="width: 10%; text-align: center">Estado</th>
                <th style="width: 15%; text-align: center">Acciones</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-cliente>
            <tr>
                <td>{{ cliente.rutCliente | formatRut }}</td>
                <td>{{ cliente.nombreCliente }}</td>

                <td style="text-align: center">
                    <span class="badge" [class.badge-success]="cliente.estado === 1"
                        [class.badge-danger]="cliente.estado !== 1">
                        {{ getEstadoLabel(cliente.estado) }}
                    </span>
                </td>
                <td style="text-align: center">
                    <div class="flex gap-1 justify-content-center">
                        <p-button icon="pi pi-receipt" [raised]="true" severity="info" pTooltip="Ver contratos"
                            (click)="verContratos(cliente)">
                        </p-button>
                        <p-button icon="pi pi-users" [raised]="true" severity="success" pTooltip="Ver contactos"
                            (click)="verContactos(cliente)">
                        </p-button>
                        @if (canCreateClient()) {
                        <p-button icon="pi pi-pencil" [raised]="true" severity="warn" pTooltip="Editar"
                            (click)="openEditClienteDialog(cliente)">
                        </p-button>
                        <p-button icon="pi pi-trash" [raised]="true" severity="danger" pTooltip="Eliminar"
                            (click)="confirmDelete(cliente)">
                        </p-button>
                        }
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5" class="text-center p-4">
                    <i class="pi pi-info-circle text-3xl mb-2"></i>
                    <p class="text-lg">No se encontraron clientes</p>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Diálogo de Cliente -->
    <p-dialog [header]="dialogTitle" [(visible)]="displayDialog" [modal]="true" [style]="{ width: '600px' }"
        [draggable]="false" [resizable]="false">
        <div class="grid p-fluid">
            @if (!isEditMode) {
            <!-- Modo Crear -->
            <div class="col-12">
                <label for="rutCliente" class="block mb-2 font-semibold">RUT <span class="text-red-500">*</span></label>
                <input pInputText id="rutCliente" [(ngModel)]="clienteFormCreate.rutCliente" placeholder="12345678-9"
                    appRutInput class="w-full" required />
            </div>
            <div class="col-12">
                <label for="nombreClienteCreate" class="block mb-2 font-semibold">Nombre Cliente <span
                        class="text-red-500">*</span></label>
                <input pInputText id="nombreClienteCreate" [(ngModel)]="clienteFormCreate.nombreCliente"
                    placeholder="Ingrese el nombre del cliente" class="w-full" required />
            </div>
            <div class="col-12">
                <label for="nombreComercialCreate" class="block mb-2 font-semibold">Nombre Comercial</label>
                <input pInputText id="nombreComercialCreate" [(ngModel)]="clienteFormCreate.nombreComercial"
                    placeholder="Ingrese el nombre comercial" class="w-full" />
            </div>
            <div class="col-12">
                <label for="razonSocialCreate" class="block mb-2 font-semibold">Razón Social</label>
                <input pInputText id="razonSocialCreate" [(ngModel)]="clienteFormCreate.razonSocial"
                    placeholder="Ingrese la razón social" class="w-full" />
            </div>
            }
            @if (isEditMode) {
            <!-- Modo Editar -->
            <div class="col-12">
                <label for="nombreClienteEdit" class="block mb-2 font-semibold">Nombre Cliente <span
                        class="text-red-500">*</span></label>
                <input pInputText id="nombreClienteEdit" [(ngModel)]="clienteFormUpdate.nombreCliente"
                    placeholder="Ingrese el nombre del cliente" class="w-full" required />
            </div>
            <div class="col-12">
                <label for="nombreComercialEdit" class="block mb-2 font-semibold">Nombre Comercial</label>
                <input pInputText id="nombreComercialEdit" [(ngModel)]="clienteFormUpdate.nombreComercial"
                    placeholder="Ingrese el nombre comercial" class="w-full" />
            </div>
            <div class="col-12">
                <label for="razonSocialEdit" class="block mb-2 font-semibold">Razón Social</label>
                <input pInputText id="razonSocialEdit" [(ngModel)]="clienteFormUpdate.razonSocial"
                    placeholder="Ingrese la razón social" class="w-full" />
            </div>
            }
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Cancelar" icon="pi pi-times" severity="secondary"
                (onClick)="displayDialog = false"></p-button>
            <p-button label="Guardar" icon="pi pi-check" (onClick)="saveCliente()"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Toast y Confirmación -->
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
</div>